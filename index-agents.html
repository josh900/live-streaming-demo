<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Avatar Demo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style-agents.css" />
  <link rel="icon" type="image/png" sizes="192x192"
    href="https://cdn.prod.website-files.com/6316d11d553f411d6f1fa732/6343f55adbb1a12a532f2769_skoop-favicon.png" />
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
    }

    .header {
      display: none;
      align-items: flex-end;
      padding: 15px;
      background-color: #f5f5f5;
      width: 100%;
      box-sizing: border-box;
    }

    .header img {
      height: 30px;
      margin-right: 15px;
    }

    .header h1 {
      font-family: 'Mulish', sans-serif;
      font-weight: 700;
      font-size: 20px;
      margin: 0;
      line-height: 1;
    }

    #content {
      padding: 20px;
    }

    /* Add this new style for initialization */
    body.initializing #content,
    body.initializing #simple-mode-button {
      display: none;
    }

    .header.hidden {
      display: none;
    }

    .header.visible {
      display: flex;
    }

    .pressed-effect {
      filter: brightness(0.8);
      color: #000;
    }

    .hide {
      display: none;
    }
  </style>
  <script>
    // Immediately-invoked function expression to avoid polluting global scope
    (function () {
      var urlParams = new URLSearchParams(window.location.search);
      var showHeader = urlParams.get('header') !== 'false';
      if (showHeader) {
        document.addEventListener('DOMContentLoaded', function () {
          document.getElementById('header-bar').classList.add('visible');
        });
      }
    })();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
</head>

<body class="initializing">
  <div class="header" id="header-bar">
    <img src="https://cdn.prod.website-files.com/6316d11d553f411d6f1fa732/633ac440413e418b480baaf8_skoop-logo-p-500.png"
      alt="SKOOP logo" />
    <h1>Avatar Demo</h1>
    <button id="simple-mode-button">Simple Mode</button>
  </div>
  <div id="content">
    <div id="left-column">
      <div id="status">
        <h4>WebRTC Connection Status</h4>
        ICE gathering status: <label id="ice-gathering-status-label"></label><br />
        ICE status: <label id="ice-status-label"></label><br />
        Peer connection status: <label id="peer-status-label"></label><br />
        Signaling status: <label id="signaling-status-label"></label><br />
        Streaming status: <label id="streaming-status-label"></label><br />
        <br />
        <div id="buttons">
          <select id="avatar-select"></select>
          <button id="connect-button" type="button">Connect</button>
          <button id="destroy-button" type="button">Destroy</button>
          <button id="edit-avatar-button" type="button">Edit Avatar</button>
        </div>
      </div>
      <div id="video-wrapper">
        <video id="idle-video-element" width="400" height="400" playsinline autoplay loop muted></video>
        <video id="stream-video-element" width="400" height="400" playsinline autoplay></video>
        <video id="preload-video-element" width="400" height="400" style="display: none"></video>
        <div id="logo-wrapper">
        <svg version="1.1" viewBox="0 0 710 300" width="740" height="340" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur in="SourceAlpha" stdDeviation="5"/>
                <feOffset dx="5" dy="5" result="offsetblur"/>
                <feFlood flood-color="rgba(0,0,0,0.3)"/>
                <feComposite in2="offsetblur" operator="in"/>
                <feMerge>
                  <feMergeNode/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>
            <rect x="20" y="20" width="670" height="260" rx="50" ry="50" fill="rgba(184, 184, 184, 1)" stroke="none" filter="url(#shadow)"/>
            <path transform="translate(150,50) scale(0.13)" d="m0 0h42l31 3 33 5 29 6 26 7 26 9 34 15 21 11 18 11 25 17 26 20 13 11 13 12 22 22 9 11 11 13 27 36 9 13 15 22 8 11 1 4-10 6-16 8-27 16-22 13-29 17-15 9-17 10-20 12-22 13-7 4-5-1-8-13-8-14-11-16-14-19-9-10-7-8-13-13-11-9-16-11-16-9-23-10-29-8-18-3-27-2h-42l-21 2-25 5-20 6-23 9-18 10-15 10-16 12-9 8-7 8-10 11-9 13-10 19-7 17-6 20-3 20v31l2 18 5 16 13 25 9 14 11 13 18 18 13 10 23 16 27 15 22 11 70 29 35 14 64 26 29 12 35 16 26 12 22 12 24 14 14 8 34 23 12 9 14 11 22 18 8 8 8 7 15 15 7 8 13 16 12 16 11 17 9 15 8 14 11 24 12 34 6 21 6 26 5 24 3 24 1 15v65l-2 28-4 28-6 31-5 19-8 26-9 25-11 25-13 25-16 27-12 17-14 19-9 11-10 11-7 8-12 13-8 7-10 10-11 9-16 13-11 8-18 13-16 10-18 10-16 9-24 11-26 10-19 7-29 8-42 9-31 4-43 4-22 1-39-3-43-5-28-5-23-5-33-9-29-11-21-9-21-10-20-12-16-10-11-8-17-13-10-8-11-9-33-33-9-11-11-14-14-19-15-23-10-17-13-24-8-17-10-24-9-24-9-28-7-26-13-52-3-15v-5l12-4 115-26 64-14 39-8h6l4 36 5 25 9 39 6 21 8 22 11 23 8 13 16 21 9 10 16 16 16 12 15 10 21 11 26 10 26 8 27 5 20 2h33l28-3 29-6 24-7 21-9 23-12 16-11 10-8 12-11 11-11 7-8 10-12 10-15 9-16 10-21 7-19 8-32 3-17 2-34v-12l-5-42-5-23-6-18-8-18-6-11-12-18-11-14-20-20-11-9-14-11-30-20-17-10-18-10-32-16-20-9-33-14-93-38-40-17-18-8-33-16-18-10-21-12-19-12-22-15-28-21-11-10-8-7-15-14-8-8-7-8-10-11-7-9-10-13-17-26-9-16-11-22-9-23-8-22-6-29-4-23-2-20v-52l3-26 7-37 7-26 8-23 9-21 15-29 20-30 9-12 9-10 7-8 9-10 26-26 11-9 11-10 16-12 18-13 18-11 19-11 19-10 36-15 34-11 49-11 45-7z" fill="#007A72"/>
            <text id="button-text" x="250" y="177" font-family="Arial, sans-serif" font-size="70" font-weight="bold"
              fill="#2E3E3D">Hold to Talk</text>
          </svg>
        </div>
      </div>
    </div>
    <div id="right-column">
      <div id="context-wrapper">
        <h4>Context:</h4>
        <select id="context-select"></select>
        <button id="edit-context-button">Edit Context</button>
        <textarea id="context-input" rows="4" cols="50" readonly></textarea>
      </div>
      <div class="chat">
        <h4>Chat History</h4>
        <div id="msgHistory"></div>
      </div>
      <div id="speak-controls">
        <button id="start-button" type="button">Speak</button>
        <button id="auto-speak-toggle" type="button">Auto-Speak: On</button>
        <button id="push-to-talk-toggle" type="button">Push to Talk: Off</button>
        <button id="push-to-talk-button" type="button" style="display: none;">Push to Talk</button>
      </div>
      <div id="text-input-controls">
        <input type="text" id="text-input" placeholder="Type your message here" />
        <button id="send-text-button" type="button">Send</button>
      </div>
    </div>
  </div>
  <div id="avatar-modal" class="modal">
    <div class="modal-content">
      <h2>Create/Edit Avatar</h2>
      <input type="hidden" id="avatar-id">
      <input type="text" id="avatar-name" placeholder="Avatar Name" />
      <input type="text" id="avatar-voice" placeholder="Voice ID" />
      <input type="file" id="avatar-image" accept="image/png" />
      <img id="avatar-image-preview" src="" alt="Avatar Preview" style="max-width: 200px; max-height: 200px" />
      <button id="save-avatar-button">Save Avatar</button>
      <button onclick="closeAvatarModal()">Cancel</button>
    </div>
  </div>
  <div id="processing-message" class="hide"></div>
  <div id="context-modal" class="modal">
    <div class="modal-content">
      <h2>Create/Edit Context</h2>
      <input type="text" id="context-name" placeholder="Context Name">
      <textarea id="context-content" rows="10" cols="50" placeholder="Context Content"></textarea>
      <button id="save-context-button">Save Context</button>
      <button onclick="closeContextModal()">Cancel</button>
    </div>
  </div>
  <script>
    // AudioWorklet implementation
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    // AudioWorklet processor code
    const workletCode = `
            class AudioProcessor extends AudioWorkletProcessor {
                process(inputs, outputs, parameters) {
                    const input = inputs[0];
                    const output = outputs[0];
                    for (let channel = 0; channel < input.length; channel++) {
                        const inputChannel = input[channel];
                        const outputChannel = output[channel];
                        for (let i = 0; i < inputChannel.length; i++) {
                            outputChannel[i] = inputChannel[i];
                        }
                    }
                    return true;
                }
            }
            registerProcessor('audio-processor', AudioProcessor);
        `;
    const blob = new Blob([workletCode], { type: 'application/javascript' });
    const workletUrl = URL.createObjectURL(blob);
    audioContext.audioWorklet
      .addModule(workletUrl)
      .then(() => {
        const audioProcessor = new AudioWorkletNode(audioContext, 'audio-processor');
        // Connect the audio processor to the audio context destination
        audioProcessor.connect(audioContext.destination);
      })
      .catch((err) => console.error('Error loading AudioWorklet:', err));
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@deepgram/sdk"></script>
  <script type="module">
    import {
      initialize,
      handleAvatarChange,
      openAvatarModal,
      closeAvatarModal,
      saveAvatar,
      updateContext,
      handleTextInput,
      toggleAutoSpeak,
      toggleSimpleMode
    } from './agents-client-api.js';
    // Make closeAvatarModal available globally
    window.closeAvatarModal = closeAvatarModal;
    // Initialize the app when the DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialize);
    } else {
      initialize();
    }
    document.getElementById('simple-mode-button').addEventListener('click', toggleSimpleMode);
  </script>

</body>

</html>